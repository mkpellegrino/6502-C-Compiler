//needs("mcplot");
needs("mul16");
needs("div16");
void main()
{
  uint JSportA = NULL;
  uint JSbtnPressA = NULL;
  uint JSnorth = NULL;
  uint JSsouth = NULL;
  uint JSwest = NULL;
  uint JSeast = NULL;
  uint rtn8bit = NULL;
  uint midJump = NULL;
  uint jumpIndex = NULL;
  word clock = NULL;
  int direction = 0x00;
  uint playerHitCeiling = NULL;
  uint playerOnFloor = NULL;
  uint prizeOnFloor = NULL;
  uint toTheRight = NULL;
  uint toTheLeft = NULL;
  word playerx = 0x0050;
  uint playery = 0x64;
  word prizex = 0x64;
  uint prizey = 0x64;
  uint thrust = 0x00;
  uint onFloorRET = NULL;
  word xtocheck = NULL;
  uint ytocheck = NULL;
  uint byte0 = NULL;
  uint byte1 = NULL;
  uint byte2 = NULL; 
  word bulletx = NULL;
  uint bullety = NULL;
  word bulletDirection = 0x0000;
  
  uint prizeDirection = 0x01;
  uint fireInProgress = 0x00;
  data characterset = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // space
    0x00, 0x30, 0x30, 0x30, 0x30, 0x00, 0x30, 0x30, // !
    0x00, 0xCC, 0xCC, 0x00, 0x00, 0x00, 0x00, 0x00, // "
    0x00, 0x3C, 0x30, 0x30, 0xFC, 0x30, 0x33, 0xFF, // Lb
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // $
    0x00, 0x30, 0xF0, 0xF0, 0x30, 0x3C, 0x3C, 0x30, // %
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // &
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // '
    0x0C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x0C, // (
    0xC0, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0xC0, // )

    0xFF, 0xFF, 0xC0, 0xC0, 0xD5, 0xD5, 0xEA, 0xEA, // *
    0xFF, 0xFF, 0x00, 0x00, 0x55, 0x55, 0xAA, 0xAA, // +
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xC0, // ,
    0x00, 0x00, 0x00, 0x3C, 0x3C, 0x00, 0x00, 0x00, // -
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, // .
    0x03, 0x03, 0x0C, 0x0C, 0x30, 0x30, 0xC0, 0xC0, // /
    0x00, 0x30, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x30, // 0
    0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, // 1
    0x00, 0x30, 0xCC, 0x0C, 0x30, 0xC0, 0xC0, 0xFC, // 2
    0x00, 0x30, 0xCC, 0x0C, 0x30, 0x0C, 0xCC, 0x30, // 3

    0x00, 0x0C, 0xCC, 0xCC, 0xFC, 0x0C, 0x0C, 0x0C, // 4
    0x00, 0xFC, 0xC0, 0xF0, 0x0C, 0x0C, 0xCC, 0x30, // 5
    0x00, 0x30, 0xCC, 0xC0, 0xF0, 0xCC, 0xCC, 0x30, // 6
    0x00, 0xFC, 0x0C, 0x0C, 0x30, 0x30, 0x30, 0x30, // 7
    0x00, 0x30, 0xCC, 0xCC, 0x30, 0xCC, 0xCC, 0x30, // 8
    0x00, 0xFC, 0xCC, 0xCC, 0xFC, 0x0C, 0x0C, 0x0C, // 9
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // :
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ;
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // <
    0x00, 0x00, 0x3C, 0x00, 0x3C, 0x00, 0x00, 0x00, // =

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // >
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ?
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // @
    0x00, 0x30, 0xFC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC,  //  A
    0x00, 0xF0, 0xCC, 0xCC, 0xF0, 0xCC, 0xCC, 0xF0, // B
    0x00, 0x30, 0xCC, 0xC0, 0xC0, 0xC0, 0xCC, 0x30, // C
    0x00, 0xF0, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xF0, // D
    0x00, 0xFC, 0xC0, 0xC0, 0xF0, 0xC0, 0xC0, 0xFC, // E
    0x00, 0xFC, 0xC0, 0xC0, 0xF0, 0xC0, 0xC0, 0xC0, // F
    0x00, 0x30, 0xCC, 0xC0, 0xFC, 0xCC, 0xCC, 0x30, // G

    0x00, 0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, // H
    0x00, 0xFC, 0x30, 0x30, 0x30, 0x30, 0x30, 0xFC, // I
    0x00, 0xFC, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x30,  // J
    0x00, 0xCC, 0xCC, 0xCC, 0xF0, 0xCC, 0xCC, 0xCC, // K
    0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFC,  // L
    0x00, 0xCC, 0xFC, 0xFC, 0xCC, 0xCC, 0xCC, 0xCC,  // M
    0x00, 0x00, 0x00, 0xC0, 0xFC, 0xCC, 0xCC, 0xCC, // N
    0x00, 0xFC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xFC,  // O
    0x00, 0xF0, 0xCC, 0xCC, 0xF0, 0xC0, 0xC0, 0xC0, // P
    0x00, 0x30, 0xCC, 0xCC, 0xCC, 0xCC, 0xF0, 0x3C, // Q

    0x00, 0xF0, 0xCC, 0xCC, 0xF0, 0xCC, 0xCC, 0xCC, // R
    0x00, 0x30, 0xCC, 0xC0, 0x30, 0x0C, 0xCC, 0x30, // S
    0x00, 0xFC, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, // T
    0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xFC, // U
    0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0x30, 0x30, 0x30, // V
    0x00, 0xCC, 0xCC, 0xCC, 0xFC, 0xFC, 0xFC, 0xCC, // W
    0x00, 0xCC, 0xCC, 0xCC, 0x30, 0xCC, 0xCC, 0xCC, // X
    0x00, 0xCC, 0xCC, 0xCC, 0x3C, 0x0C, 0xCC, 0x30, // Y
    0x00, 0xFC, 0x0C, 0x0C, 0x30, 0xC0, 0xC0, 0xFC, // Z
    //0x0F, 0x35, 0xD5, 0xD5, 0xEA, 0xEA, 0x3A, 0x0F, // [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, // ladder0

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // Lb
    //0xF0, 0x5C, 0x57, 0x57, 0xAB, 0xAB, 0xAC, 0xF0, // ]
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, // ladder 1
    //0x00, 0x3C, 0xC3, 0x00, 0x00, 0x00, 0x00, 0x00, // ^
    0x03, 0x00, 0x03, 0x03, 0x03, 0x03, 0xFF, 0xFF, // ladder2
    //0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // <-- (~)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0,  // ladder3
    0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00 // -
  };

  data ladder = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0xFF, 0xFF, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0 
  };
  word general16bit = NULL;
  uint general8bit = NULL;
  // Blue and Red
  uint plotshapeColourValue0110;
  // White
  uint plotshapeColourValue11;

  uint textColour;
  inc( textColour );

  data titleText = { "PLATFORMER:  MICHAEL K. PELLEGRINO" };
  data rung = { "[]^~" };

  
  saveregs();
  bank( 2 );

  poke( 0xD020, 0x05 );
  poke( 0xD021, 0x00 );
  
  asmcomment( "multicolour bitmap mode" );
  setScreenMode(3);
  poke( 0xD018, 0x18 );
  
  romout(6);
    
  word bmpaddr = getbmp_addr();
  word scraddr = getscr_addr();
  
  bmPrintInit( 0xA0, 0x84, characterset );
  
  // colour
  // 11 - green
  fillmem( 0xD8, 0x05, 0x04 );

  // 01 - 07
  // 10 - 0D
  fillmem( 0x84, 0x7D, 0x12 );

  // bitmap
  clearmem( 0xA0, 0x20 );

  bmPrint( 0x03, 0x00, titleText, 0x01, 0x23 );

  // almost all sprites MC
  poke( 0xD01C, 0xFB );
  
  data playerFramesR = { 0x20, 0x21, 0x22, 0x23, 0x22, 0x21 };
  data playerFramesL = { 0x24, 0x25, 0x26, 0x27, 0x26, 0x25 };
  data playerFramesUD = { 0x28, 0x29, 0x2A, 0x2B, 0x2A, 0x29 };

  data bugFramesLR = { 0x2C, 0x2D, 0x2E, 0x2F, 0x2E, 0x2D };
  
  uint playerFrameR[6];
  uint playerFrameL[6];
  uint playerFrameUD[6];
  uint bugFrameLR[6];
  
  for( uint i = 0x00; i < 0x06; inc( i ) )
    {
      playerFrameR[i] = peek(playerFramesR + i);
      playerFrameL[i] = peek(playerFramesL + i);
      playerFrameUD[i] = peek(playerFramesUD + i);
      bugFrameLR[i] = peek(bugFramesLR + i);
    }

  uint status = 0x00;

  setfilename( "WALKER4,S,R" );
  setlfs( 3, 8, 3 );
  fopen();
  fchkin( 3 );

  word saddr = 0x8800;
  while( status == 0x00 )
    {    
      poke( saddr, fchrin() );
      saddr = saddr + 0x0001;
      status = peek( 0x0090 );
    }
  fclose(3);
  fclrchn();
  

  word sprptr0 = scraddr + 0x03F8;
  word sprptr1 = scraddr + 0x03F9;
  word sprptr2 = scraddr + 0x03FA;

  asmcomment( "universal sprite colours" );
  poke( 0xD025, 0x01 );
  poke( 0xD026, 0x0B );

  poke( sprptr0, playerFrameR[0] );
  poke( sprptr1, bugFrameLR[0] );
  poke( sprptr2, 0x30 );
  
  spritecolour( 0x00, 0x09 );
  spritecolour( 0x01, 0x0C );
  spritecolour( 0x02, 0x02 );

  spritexy( 0x00, playerx, playery );
  spritexy( 0x01, prizex, prizey );
  spritexy( 0x02, bulletx, bullety );
  spriteset( 0x07 );

  data floorplan = {
    1, 20, 159, 20,
      
    1, 48, 72, 48,
    96, 48, 159, 48,

    24, 76, 136, 76,

    1, 104, 64, 104,

    24, 132, 136, 120,

    1, 160, 72, 160,
    96, 160, 159, 160,

    1, 188, 159, 195
  };

  word floorplanptr = floorplan;
  word floorplanptrX = floorplan + 0x0024;

  
  for( word j = floorplanptr; j < floorplanptrX; j = j + 0x0004  )
    {
      line( peek( j ), peek( j + 0x0001 ), peek( j + 0x0002 ), peek( j + 0x0003 ), 0x03 );
    }

  bmPrint( 0x0A, 0x0A, rung, 0x09, 0x23 );
  bmPrint( 0x0A, 0x0B, rung, 0x09, 0x23 );
  bmPrint( 0x0A, 0x0C, rung, 0x09, 0x23 );
  bmPrint( 0x0A, 0x0D, rung, 0x09, 0x23 );


  //uint movingFlag = 0x00;
  uint frame = 0x00;
  uint bugFrame = 0x00;
  uint keepPlaying = 0x00;
  uint c = getin();
  while( keepPlaying != 0x01 )
    {
      getJS();
      playerOnFloor = onFloor();
      playerHitCeiling = hitCeiling();
      
      prizeOnFloor = prizeOnFloorFunc();
      
      if( c == 60 )
	{
	  JSbtnPressA = 0x00;
	}
      if( c == 33 )
	{
	  // UP
	  JSnorth = 0x00;
	}
      if( c == 37 )
	{
	  // DOWN
	  JSsouth = 0x00;
	}
      if( c == 30 )
	{
	  // LEFT
	  JSwest = 0x00;
	}
      if( c == 38 )
	{
	  // RIGHT
	  JSeast = 0x00;
	}
      if( c == 62 )
	{
	  // Q for QUIT
	  keepPlaying = 0x01;
	}
      
      if( JSbtnPressA == 0x00 && playerOnFloor != 0x00 )
	{
	  if( playerHitCeiling == 0x00 )
	    {
	      // initiate jump sequence
	      midJump = 0x01;
	      jumpIndex = 0x00;
	    }
	}
            
      if( playerHitCeiling != 0x00 )
	{
	  midJump = 0x00;
	  thrust = 0x00;
	}
	  
      if( JSsouth == 0x00 && playerOnFloor == 0x00 )
	{
	  inc(playery);
	}

      if( playerOnFloor != 0x00 )
	{
	  if( JSeast == 0x00 && playerx < 0x0140)
	    {
	      toTheRight = whatsToTheRight();
	      
	      if( toTheRight == 0x01 )
		{
		  playery = playery - 0x01;
		}
	      if( toTheRight != 0xFF )
		{
		  direction = 1;
		  playerx = playerx + 0x0001;
		}
	      //movingFlag = 0x01;
	      poke( sprptr0, playerFrameR[frame] );
	      inc( frame );
	      if( frame > 0x05 )
		{
		  frame = 0x00;	  
		}	  

	      
	    }
	  if( JSwest == 0x00 && playerx > 0x0018 )
	    {
	      toTheLeft = whatsToTheLeft();
	      if( toTheLeft == 0x01 )
		{
		  playery = playery - 0x01;
		}
	      if( toTheLeft != 0xFF )
		{
		  direction = -1;
		  playerx = playerx - 0x0001;
		}
	      //movingFlag = 0x01;
	      poke( sprptr0, playerFrameL[frame] );
	      inc( frame );
	      if( frame > 0x05 )
		{
		  frame = 0x00;	  
		}	  
	    }
	}

      //if( movingFlag == 0x00 )
      //{
      //  poke( sprptr0, 0x28 );
      //}
      //movingFlag = 0x00;

      if( midJump != 0x00 )
	{
	  playery = playery + 0xFD;
	  inc(jumpIndex);
	  jumpIndex = jumpIndex & 0x0F;
	  midJump = jumpIndex;

	  if( direction == -1 )
	    {
	      playerx = playerx - 0x0001;
	    }
	  else
	    {
	      playerx = playerx + 0x0001;
	    }
	  limitxposition();
	}
      
      gravity();

      
      if( thrust != 0x00 )
	{
	  playery = playery - thrust;
	  dec( thrust );
	}

      for( word DELAY = 0x0000; DELAY < 0x00AF; DELAY = DELAY + 0x0001 )
	{
	  nop();
	}
      
      if( playery == prizey && fireInProgress == 0x00)
	{
       spriteset( 0x07 );
       fireInProgress = 0x01;
       bulletx = prizex;
       bullety = prizey;
       if( prizex > playerx )
         {
           bulletDirection = 0xFFFF;
         }
       else
         {
           bulletDirection = 0x0001;
         }
      }

      if( fireInProgress == 0x01 )
      {
       if( bulletx < 0x0014 || bulletx > 0x0160 )
         {
           fireInProgress = 0x00;
           spriteset( 0x03 );
         }
       bulletx = bulletx + bulletDirection;
       
      }
      positionMOBS();
      c = getin();	    
    }
  
  clearkb();

  romin();

  bank(0);
  restoreregs();
  
  return;
}

void limityposition()
{
  if( playery < 0x32 )
    {
      playery = 0x32;
    }
  if( playery > 0xC8 )
    {
      playery = 0xC8;
    }


  return;
}
void limitxposition()
{
  if( playerx > 0x0140 )
    {
      playerx = 0x0140;
    }
  if( playerx < 0x0018 )
    {
      playerx = 0x0018;
    }
  return;
}

void positionMOBS()
{  
  positionBug();
  spritexy( 0x00, playerx, playery );
  spritexy( 0x01, prizex, prizey );
  if( fireInProgress == 0x01 )
  {
    spritexy( 0x02, bulletx, bullety );      
  }
  return;
}

void gravity()
{
  if( playerOnFloor == 0x00 )
    {
      inc( playery );

      if( direction == 1 )
	{
	  playerx = playerx + 1;
	}
      else
	{
	  playerx = playerx - 1;
	}
      limitxposition();
    }
      
  if( prizeOnFloor == 0x00 )
    {
      inc( prizey );
    }
  return;
}

uint whatsToTheRight()
{
  rtn8bit = 0x00;
  xtocheck = playerx - 0x0004;
  ytocheck = playery - 0x1E;
  
  byte0 = peek(getpixel( xtocheck, ytocheck  ));
  byte1 = peek(getpixel( xtocheck, ytocheck - 0x01  ));

  if( byte0 != 0x00 || byte1 != 0x00 )
    {
      if( byte1 == 0x00 )
	{
	  inc( rtn8bit );
	}
      else
	{
	  dec( rtn8bit );
	}
    }
  return rtn8bit;
}

uint whatsToTheRight2()
{
  rtn8bit = 0x00;
  xtocheck = prizex - 0x0004;
  ytocheck = prizey - 0x1E;
  
  byte0 = peek(getpixel( xtocheck, ytocheck  ));
  byte1 = peek(getpixel( xtocheck, ytocheck - 0x01  ));

  if( byte0 != 0x00 || byte1 != 0x00 )
    {
      if( byte1 == 0x00 )
	{
	  inc( rtn8bit );
	}
      else
	{
	  dec( rtn8bit );
	}
    }
  return rtn8bit;
}

uint whatsToTheLeft2()
{
  rtn8bit = 0x00;
  xtocheck = prizex - 0x000C;
  ytocheck = prizey - 0x1E;
  
  byte0 = peek(getpixel( xtocheck, ytocheck  ));
  byte1 = peek(getpixel( xtocheck, ytocheck - 0x01  ));

  if( byte0 != 0x00 || byte1 != 0x00 )
    {
      if( byte1 == 0x00 )
	{
	  inc( rtn8bit );
	}
      else
	{
	  dec( rtn8bit );
	}
    }
  return rtn8bit;
}

uint whatsToTheLeft()
{
  rtn8bit = 0x00;
  xtocheck = playerx - 0x000C;
  ytocheck = playery - 0x1E;
  
  byte0 = peek(getpixel( xtocheck, ytocheck  ));
  byte1 = peek(getpixel( xtocheck, ytocheck - 0x01  ));

  if( byte0 != 0x00 || byte1 != 0x00 )
    {
      if( byte1 == 0x00 )
	{
	  inc( rtn8bit );
	}
      else
	{
	  dec( rtn8bit );
	}
    }
  return rtn8bit;
}

uint onFloor()
{
  word RIGHT = getpixel( playerx - 0x0004, playery - 0x1D );
  byte0 = peek( RIGHT );
  byte1 = peek( RIGHT - 0x0008 );
  byte2 = peek( RIGHT - 0x0010 );
  rtn8bit = byte0 | byte1;
  rtn8bit = rtn8bit | byte2;
  return rtn8bit;
}

uint hitCeiling()
{
  RIGHT = getpixel( playerx - 0x0004, playery - 0x32 );
  byte0 = peek( RIGHT );
  byte1 = peek( RIGHT - 0x0008 );
  byte2 = peek( RIGHT - 0x0010 );
  rtn8bit = byte0 | byte1;
  rtn8bit = rtn8bit | byte2;
  return rtn8bit;
}

uint prizeOnFloorFunc()
{
  RIGHT = getpixel( prizex - 0x0004, prizey - 0x1D );
  byte0 = peek( RIGHT );
  byte1 = peek( RIGHT - 0x0008 );
  byte2 = peek( RIGHT - 0x0010 );
  rtn8bit = byte0 | byte1;
  rtn8bit = rtn8bit | byte2;
  return rtn8bit;
}

void clearkb()
{
  poke( 198, 0 );
  jsr( 65508 );
  return;
}

void getJS()
{
  JSportA = peek(0xDC00);
  JSbtnPressA = JSportA & 0x10;
  JSnorth = JSportA & 0x01;
  JSsouth = JSportA & 0x02;
  JSwest = JSportA & 0x04;
  JSeast = JSportA & 0x08;
  return;
}

void line( uint X1, uint Y1, uint X2, uint Y2, uint C0)
{
  //dec( X1);
  segment( X1, Y1, X2, Y2, C0 );
  inc( Y1 );
  inc( Y2 );
  segment( X1, Y1, X2, Y2, C0 );
  return;
}

void positionBug()
{
  prizeOnFloor = prizeOnFloorFunc();

  if( prizex < 0x0046 || prizex > 0x0112 )
    {
      inline( "lda #$FF", 2 );
      inline( "eor prizeDirection", 3 );
      inline( "sta prizeDirection", 3 );
    }
  if( fireInProgress == 0x00 )
    {
      poke( sprptr1, bugFrameLR[bugFrame] );
      inc( bugFrame );
      if( bugFrame > 0x05 )
	{
	  bugFrame = 0x00;
	}
      if( prizeDirection == 0x01 )
	{
	  // to climb slopes
	  if( whatsToTheRight2() != 0x00 )
	    {
	      dec(prizey);
	    }
	  prizex = prizex + 0x0001;
	}
      else
	{
	  // to climb slopes
	  if( whatsToTheLeft2() != 0x00 )
	    {
	      dec(prizey);
	    }      
	  prizex = prizex + 0xFFFF;
	}
    }
  else
  {
    bulletx = bulletx + bulletDirection;
  }

  
  return;
}

void switchPrizeDirections()
{
  inline( "lda #$FF", 2 );
  inline( "eor prizeDirection", 3 );
  inline( "sta prizeDirection", 3 );
  return;
}
